package com.sap.psr.vulas.backend.util;

import java.util.HashSet;
import java.util.Properties;
import java.util.Set;

import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.activation.FileDataSource;
import javax.mail.BodyPart;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.PasswordAuthentication;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;
import javax.validation.constraints.NotNull;

import org.apache.commons.configuration.Configuration;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.sap.psr.vulas.shared.util.StopWatch;
import com.sap.psr.vulas.shared.util.VulasConfiguration;

public class SmtpClient {
	
	private static Logger log = LoggerFactory.getLogger(SmtpClient.class);
	
	public final static String SMTP_HOST = "vulas.backend.smtp.host";
	public final static String SMTP_PORT = "vulas.backend.smtp.port";
	public final static String SMTP_USER = "vulas.backend.smtp.user";
	public final static String SMTP_PWD  = "vulas.backend.smtp.pwd";
	
	private Properties props = null;
	
	public SmtpClient() throws IllegalStateException {
		this.props = SmtpClient.getSmtpProperties(VulasConfiguration.getGlobal().getConfiguration());
	}
		
	public void send(@NotNull com.sap.psr.vulas.backend.util.Message _msg) throws MessagingException {
		if(_msg.hasAttachment())
			this.sendWithAttachement(_msg);
		else
			log.error("Messages without attachment are not supported");
	}
	
	private void sendWithAttachement(@NotNull com.sap.psr.vulas.backend.util.Message _msg) throws MessagingException {
		final StopWatch sw = new StopWatch("Send message " + _msg).start();

		final Session session = Session.getInstance(props,
				new javax.mail.Authenticator() {
			protected PasswordAuthentication getPasswordAuthentication() {
				return new PasswordAuthentication(VulasConfiguration.getGlobal().getConfiguration().getString(SMTP_USER), VulasConfiguration.getGlobal().getConfiguration().getString(SMTP_PWD));
			}
		});

		try {
			final Message message = new MimeMessage(session);
			message.setSubject(_msg.getSubject());
			message.setFrom(new InternetAddress(_msg.getSender()));
			
			// Recipients
			final InternetAddress[] to = SmtpClient.transform(_msg.getRecipients());
			if(to.length==0)
				throw new MessagingException("No valid recipients in " + _msg.getRecipients());
			else 
				message.setRecipients(Message.RecipientType.TO,	to);
			
			// Create a multipart message
			Multipart multipart = new MimeMultipart();

			// Text
			BodyPart messageBodyPart = new MimeBodyPart();
			messageBodyPart.setText(_msg.getBody());
			multipart.addBodyPart(messageBodyPart);

			// Attachment
			messageBodyPart = new MimeBodyPart();
			final DataSource source = new FileDataSource(_msg.getAttachment().toFile());
			messageBodyPart.setDataHandler(new DataHandler(source));
			messageBodyPart.setFileName(_msg.getAttachment().getFileName().toString());
			multipart.addBodyPart(messageBodyPart);

			// Send
			message.setContent(multipart);
			Transport.send(message);
			sw.stop();
		} catch (MessagingException e) {
			sw.stop(e);
			throw e;
		}
	}
	
	static final InternetAddress[] transform(Set<String> _recipients) {
		Set<InternetAddress> recipients = new HashSet<InternetAddress>();
		for(String to : _recipients) {
			try {
				recipients.add(InternetAddress.parse(to)[0]);
			} catch (AddressException e) {
				log.error("[" + to + "] is not a valid email address");
			}
		}
		return recipients.toArray(new InternetAddress[recipients.size()]);
	}
	
	/**
	 * Returns {@link Properties} with all SMTP settings. Throws an {@link IllegalStateException} if
	 * {@link #SMTP_HOST} or {@link SMTP_PORT} are not set.
	 * 
	 * @param _cfg
	 * @return
	 */
	public static Properties getSmtpProperties(Configuration _cfg) throws IllegalStateException {
		final String host = _cfg.getString(SMTP_HOST);
		final String port = _cfg.getString(SMTP_PORT);
		if(host==null || port==null)
			throw new IllegalStateException("Cannot setup SMTP client, configuration settings [" + SMTP_HOST + "] and/or [" + SMTP_PORT + "] are not present");
		
		final Properties props = new Properties();
		props.put("mail.smtp.auth", "true");
		//props.put("mail.smtp.starttls.enable", "true");
		props.put("mail.smtp.host", host);
		props.put("mail.smtp.port", port);
		
		return props;
	}
}
